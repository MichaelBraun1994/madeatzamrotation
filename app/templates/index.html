<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Made@ZAM</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: sans-serif;
    }

      .polaroid {
    width: 500px;
    height: 640px;
    background: white;
    padding: 10px;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
    border: 1px solid #ccc;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .polaroid img {
    width: 100%;
    height: 85%;
    background-color: black;
    object-fit: contain;
    display: block;
  }

  .caption {
    padding: 10px;
    text-align: center;
    font-size: clamp(0.8em, 1vw, 1.2em);
    word-wrap: break-word;
    overflow-y: auto;
    flex-grow: 1;
  }
  </style>
</head>
<body>
  <div class="polaroid">
    <img id="photo" src="" alt="Loading.." />
    <div class="caption" id="caption"></div>
  </div>

  <script>
    async function fetchImageData() {
      try {
        response = await fetch('/api/images')
        response = await response.json()
        imagePosts = response

        imageIndex = 0
        postIndex = 0
      }
      catch(error) {
        console.error('Error fetching image data:', error)
      }
    }

    const photo = document.getElementById("photo");
    const caption = document.getElementById("caption");

    function setCaption(username, message) {
      if (message.length > 0) {
        newMessage = "<b>@" + username + ":</b> " + message;
      }
      else {
        newMessage = "<b>@" + username + "</b>";
      }

      caption.innerHTML = newMessage;
    }

    function setImage(postIndex, imageIndex) {
      imagePost = imagePosts[postIndex]

      photo.src = imagePost["image_files"][imageIndex];
      setCaption(imagePost["username"], imagePost["message"])
    }

    function presentNextImage() {
      if (imagePosts.length == 0) {
        return;
      }

      setImage(postIndex, imageIndex);

      if (imageIndex == imagePosts[postIndex]["image_files"].length - 1) {
        postIndex = (postIndex + 1) % imagePosts.length;
        imageIndex = 0;
      }
      else {
        imageIndex = imageIndex + 1;
      }
    }

    function randomizePolaroidRotation() {
      const polaroids = document.querySelectorAll('.polaroid');
      polaroids.forEach(el => {
        const range = 12
        const angle = (Math.random() * range - (range / 2)).toFixed(2);
        el.style.transform = `rotate(${angle}deg)`;
      });
    }

    photo.addEventListener('load', () => {
        randomizePolaroidRotation()
    });

    let imagePosts = []
    let postIndex = 0;
    let imageIndex = 0;

    function setPolaroidsVisibility(visibility) {
      polaroidElements = document.getElementsByClassName('polaroid');
      for (let i = 0; i < polaroidElements.length; i++) {
        polaroidElements[i].style.display = visibility ? 'block' : 'none';
      }
    }

    fetchImageData();
    setPolaroidsVisibility(true);
    presentNextImage(); 

    const IMAGE_DATA_UPDATE_INTERVAL = 1000 * 60 * 15;
    const SINGLE_IMAGE_PRESENTATION_DURATION = 2000
    setInterval(fetchImageData, IMAGE_DATA_UPDATE_INTERVAL); 
    setInterval(presentNextImage, SINGLE_IMAGE_PRESENTATION_DURATION); 
  </script>
</body>
</html>
