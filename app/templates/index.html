<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Polaroid Image Rotator</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: sans-serif;
    }

    .polaroid {
      display: none;
      background: white;
      padding: 10px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
      border: 1px solid #ccc;
      width: 300px;
      text-align: center;
      transform: rotate(-2deg);
    }

    .polaroid img {
      width: 100%;
      height: auto;
      display: block;
    }

    .caption {
      margin-top: 10px;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="polaroid">
    <img id="photo" src="" alt="Loading.." />
    <div class="caption" id="caption"></div>
  </div>

  <script>
    async function fetchImageData() {
      try {
        response = await fetch('/api/images')
        response = await response.json()
        imageData = response
      }
      catch(error) {
        console.error('Error fetching image data:', error)
      }
    }

    const photo = document.getElementById("photo");
    const caption = document.getElementById("caption");

    function setImage(imageIndex) {
      photo.src = imageData[imageIndex];
      caption.textContent = "Hello World"; //images[i].caption;
    }

    function presentNextImage() {
      if (imageData.length == 0) {
        return;
      }

      setImage(imageIndex);
      imageIndex = (imageIndex + 1) % imageData.length;

      if (Number.isNaN(imageIndex)) {
        console.log(imageData.length)
        console.log(imageData)
        console.log("DAMN")
      }
    }

    function randomizePolaroidRotation() {
      const polaroids = document.querySelectorAll('.polaroid');
      polaroids.forEach(el => {
        const range = 12
        const angle = (Math.random() * range - (range / 2)).toFixed(2);
        el.style.transform = `rotate(${angle}deg)`;
      });
    }

    photo.addEventListener('load', () => {
        randomizePolaroidRotation()
    });

    let imageData = []
    let imageIndex = 0;

    function setPolaroidsVisibility(visibility) {
      polaroidElements = document.getElementsByClassName('polaroid');
      for (let i = 0; i < polaroidElements.length; i++) {
        polaroidElements[i].style.display = visibility ? 'block' : 'none';
      }
    }

    fetchImageData();
    setPolaroidsVisibility(true);
    presentNextImage(); 

    const IMAGE_DATA_UPDATE_INTERVAL = 1000 * 60 * 15;
    const SINGLE_IMAGE_PRESENTATION_DURATION = 2000
    setInterval(fetchImageData, IMAGE_DATA_UPDATE_INTERVAL); 
    setInterval(presentNextImage, SINGLE_IMAGE_PRESENTATION_DURATION); 
  </script>
</body>
</html>
